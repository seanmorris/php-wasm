name: Build Artifacts
on: [push]
jobs:
  # build-libs:
    # name: Build Shared Objects
    # runs-on: ubuntu-latest
    # steps:
    #   - name: Check out repository code
    #     uses: actions/checkout@v4

    #   - name: Disable man-db auto-update
    #     run: |
    #       echo "set man-db/auto-update false" | sudo debconf-communicate
    #       sudo dpkg-reconfigure man-db

    #   - run: npm install
    #   - run: find . -type f -name "*.a" -exec touch {} +

    #   - run: sudo apt update && sudo apt install docker-compose -y
    #   - run: cp .circleci/.env_8.4-dynamic.ci .env

    #   - run: time make image
    #   - run: docker network create phpwasm_default

    #   - run: time make dynamic

    #   - name: Upload artifact
    #     uses: actions/upload-artifact@v4
    #     with:
    #       name: php-dependencies
    #       include-hidden-files: true
    #       path: |
    #         third_party
    #         lib
    #         packages

  build-8-4:
    name: Build 8.4
    runs-on: ubuntu-latest
    # needs: [build-libs]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Disable man-db auto-update
        run: |
          echo "set man-db/auto-update false" | sudo debconf-communicate
          sudo dpkg-reconfigure man-db

      # - name: Download artifact
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: php-dependencies
      #     path: ./

      - run: npm install
      - run: find . -type f -name "*.a" -exec touch {} +

      - run: sudo apt update && sudo apt install docker-compose -y
      - run: cp .circleci/.env_8.4-dynamic.ci .env

      - run: time make image
      - run: docker network create phpwasm_default

      - run: time make PHP_VERSION=8.4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: php-wasm-8.4
          include-hidden-files: true
          path: packages/

  build-8-3:
      name: Build 8.3
      runs-on: ubuntu-latest
      # needs: [build-libs]
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Disable man-db auto-update
          run: |
            echo "set man-db/auto-update false" | sudo debconf-communicate
            sudo dpkg-reconfigure man-db

        # - name: Download artifact
        #   uses: actions/download-artifact@v4
        #   with:
        #     name: php-dependencies
        #     path: ./

        - run: npm install
        - run: sudo apt update && sudo apt install docker-compose -y
        - run: cp .circleci/.env_8.3-dynamic.ci .env

        - run: time make image
        - run: docker network create phpwasm_default

        - run: time make PHP_VERSION=8.3

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: php-wasm-8.3
            include-hidden-files: true
            path: packages/

  build-8-2:
      name: Build 8.2
      runs-on: ubuntu-latest
      # needs: [build-libs]
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Disable man-db auto-update
          run: |
            echo "set man-db/auto-update false" | sudo debconf-communicate
            sudo dpkg-reconfigure man-db

        # - name: Download artifact
        #   uses: actions/download-artifact@v4
        #   with:
        #     name: php-dependencies
        #     path: ./

        - run: npm install
        - run: sudo apt update && sudo apt install docker-compose -y
        - run: cp .circleci/.env_8.2-dynamic.ci .env

        - run: time make image
        - run: docker network create phpwasm_default

        - run: time make PHP_VERSION=8.2

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: php-wasm-8.2
            include-hidden-files: true
            path: packages/

  build-8-1:
      name: Build 8.1
      runs-on: ubuntu-latest
      # needs: [build-libs]
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Disable man-db auto-update
          run: |
            echo "set man-db/auto-update false" | sudo debconf-communicate
            sudo dpkg-reconfigure man-db

        # - name: Download artifact
        #   uses: actions/download-artifact@v4
        #   with:
        #     name: php-dependencies
        #     path: ./

        - run: npm install
        - run: sudo apt update && sudo apt install docker-compose -y
        - run: cp .circleci/.env_8.1-dynamic.ci .env

        - run: time make image
        - run: docker network create phpwasm_default

        - run: time make PHP_VERSION=8.1

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: php-wasm-8.1
            include-hidden-files: true
            path: packages/

  build-8-0:
      name: Build 8.0
      runs-on: ubuntu-latest
      # needs: [build-libs]
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Disable man-db auto-update
          run: |
            echo "set man-db/auto-update false" | sudo debconf-communicate
            sudo dpkg-reconfigure man-db

        # - name: Download artifact
        #   uses: actions/download-artifact@v4
        #   with:
        #     name: php-dependencies
        #     path: ./

        - run: npm install
        - run: sudo apt update && sudo apt install docker-compose -y
        - run: cp .circleci/.env_8.0-dynamic.ci .env

        - run: time make image
        - run: docker network create phpwasm_default

        - run: time make PHP_VERSION=8.0

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: php-wasm-8.0
            include-hidden-files: true
            path: packages/

  Collect:
      name: Collect Artifacts
      runs-on: ubuntu-latest
      needs: [build-8-4, build-8-3, build-8-2, build-8-1, build-8-0]
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Disable man-db auto-update
          run: |
            echo "set man-db/auto-update false" | sudo debconf-communicate
            sudo dpkg-reconfigure man-db

        - run: npm install
        - run: sudo apt update && sudo apt install docker-compose -y
        - run: cp .circleci/.env_8.4-dynamic.ci .env

        - run: time make image
        - run: docker network create phpwasm_default

        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: php-wasm-8.4
            path: packages/

        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: php-wasm-8.3
            path: packages/

        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: php-wasm-8.2
            path: packages/

        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: php-wasm-8.1
            path: packages/

        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: php-wasm-8.0
            path: packages/

        - run: ./compress-package.sh packages/php-wasm
        - run: ./compress-package.sh packages/php-cgi-wasm
        - run: ./compress-package.sh packages/php-dbg-wasm

        - name: Upload artifacts
          uses: actions/upload-artifact@v4
          with:
            name: my-shared-files
            include-hidden-files: true
            path: packages/