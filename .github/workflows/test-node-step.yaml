name: Build Step

on:
  workflow_call:
    inputs:
      phpVersion:
        required: true
        type: string
      libType:
        required: true
        type: string
      testType:
        required: true
        type: string

  test:
    name: Test ${{ inputs.testType }} ${{ inputs.phpVersion }} ${{ inputs.libType }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: |
          cp -p .github/.env_${{ inputs.phpVersion }}.${{ inputs.libType }}.ci .env
          touch -d '1970-01-01 00:00:00 UTC' .env
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: php-wasm-${{ inputs.libType }}-*
          path: packages/
          merge-multiple: true
      - run: npm ci
      - run: npm install -g deno
      - name: Disable man-db auto-update
        run: |
          echo "set man-db/auto-update false" | sudo debconf-communicate
          sudo dpkg-reconfigure man-db
      - run: sudo apt update && sudo apt install docker-compose -y
      - run: make image
      - run: docker network create phpwasm_default
      - run: PHP_VERSION=${{ inputs.phpVersion }} make test-${{ inputs.testType }}