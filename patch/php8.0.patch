diff --git a/third_party/php8.0-src/ext/libxml/libxml.c b/third_party/php8.0-src/ext/libxml/libxml.c
index 73486ae2..8e19e265 100644
--- a/third_party/php8.0-src/ext/libxml/libxml.c
+++ b/third_party/php8.0-src/ext/libxml/libxml.c
@@ -43,6 +43,15 @@
 #include "php_libxml.h"
 #include "libxml_arginfo.h"
 
+__attribute__((weak)) const char *xmlParserVersion = {0};
+__attribute__((weak)) void (*xmlFree)(void *);
+__attribute__((weak)) void *(*xmlMalloc)(size_t);
+__attribute__((weak)) void *(*xmlMallocAtomic)(size_t);
+__attribute__((weak)) char *(*xmlMemStrdup)(const char *);
+__attribute__((weak)) void *(*xmlRealloc)(void *, size_t);
+__attribute__((weak)) void (*xmlGenericError)(void *, const char *, ...);
+__attribute__((weak)) void (*xmlStructuredError)(void *, xmlErrorPtr);
+
 #define PHP_LIBXML_ERROR 0
 #define PHP_LIBXML_CTX_ERROR 1
 #define PHP_LIBXML_CTX_WARNING 2
@@ -795,6 +804,26 @@ PHP_LIBXML_API void php_libxml_switch_context(zval *context, zval *oldcontext)
 
 static PHP_MINIT_FUNCTION(libxml)
 {
+	void *handle = DL_LOAD("libxml2.so");
+
+	xmlParserVersion = (const char*)dlsym(handle, "xmlParserVersion");
+
+	// fprintf(stderr, "%x\n", xmlParserVersion);
+
+	if (xmlParserVersion == NULL) {
+		// zend_disable_class("LibXMLError", sizeof("LibXMLError") - 1);
+		// zend_disable_functions(
+		//	"libxml_set_streams_context,"
+		//	"libxml_use_internal_errors,"
+		//	"libxml_get_last_error,"
+		//	"libxml_get_errors,"
+		//	"libxml_clear_errors,"
+		//	"libxml_disable_entity_loader,"
+		//	"libxml_set_external_entity_loader,"
+		// );
+		return SUCCESS;
+	}
+
 	zend_class_entry ce;
 
 	php_libxml_initialize();
@@ -903,6 +932,8 @@ static PHP_MINIT_FUNCTION(libxml)
 
 static PHP_RINIT_FUNCTION(libxml)
 {
+	if (xmlParserVersion == NULL) return SUCCESS;
+
 	if (_php_libxml_per_request_initialization) {
 		/* report errors via handler rather than stderr */
 		xmlSetGenericErrorFunc(NULL, php_libxml_error_handler);
@@ -921,6 +952,8 @@ static PHP_RINIT_FUNCTION(libxml)
 
 static PHP_RSHUTDOWN_FUNCTION(libxml)
 {
+	if (xmlParserVersion == NULL) return SUCCESS;
+
 	_php_libxml_destroy_fci(&LIBXML(entity_loader).fci, &LIBXML(entity_loader).object);
 
 	return SUCCESS;
@@ -928,6 +961,8 @@ static PHP_RSHUTDOWN_FUNCTION(libxml)
 
 static PHP_MSHUTDOWN_FUNCTION(libxml)
 {
+	if (xmlParserVersion == NULL) return SUCCESS;
+
 	if (!_php_libxml_per_request_initialization) {
 		xmlSetGenericErrorFunc(NULL, NULL);
 
@@ -941,6 +976,8 @@ static PHP_MSHUTDOWN_FUNCTION(libxml)
 
 static zend_result php_libxml_post_deactivate(void)
 {
+	if (xmlParserVersion == NULL) return SUCCESS;
+
 	/* reset libxml generic error handling */
 	if (_php_libxml_per_request_initialization) {
 		xmlSetGenericErrorFunc(NULL, NULL);
@@ -966,6 +1003,8 @@ static zend_result php_libxml_post_deactivate(void)
 
 static PHP_MINFO_FUNCTION(libxml)
 {
+	if (xmlParserVersion == NULL) return;
+
 	php_info_print_table_start();
 	php_info_print_table_row(2, "libXML support", "active");
 	php_info_print_table_row(2, "libXML Compiled Version", LIBXML_DOTTED_VERSION);
@@ -978,6 +1017,8 @@ static PHP_MINFO_FUNCTION(libxml)
 /* {{{ Set the streams context for the next libxml document load or write */
 PHP_FUNCTION(libxml_set_streams_context)
 {
+	if (xmlParserVersion == NULL) return;
+
 	zval *arg;
 
 	ZEND_PARSE_PARAMETERS_START(1, 1)
@@ -995,6 +1036,8 @@ PHP_FUNCTION(libxml_set_streams_context)
 /* {{{ Disable libxml errors and allow user to fetch error information as needed */
 PHP_FUNCTION(libxml_use_internal_errors)
 {
+	if (xmlParserVersion == NULL) return;
+
 	xmlStructuredErrorFunc current_handler;
 	zend_bool use_errors, use_errors_is_null = 1, retval;
 
@@ -1035,6 +1078,8 @@ PHP_FUNCTION(libxml_use_internal_errors)
 /* {{{ Retrieve last error from libxml */
 PHP_FUNCTION(libxml_get_last_error)
 {
+	if (xmlParserVersion == NULL) return;
+
 	xmlErrorPtr error;
 
 	ZEND_PARSE_PARAMETERS_NONE();
@@ -1066,6 +1111,7 @@ PHP_FUNCTION(libxml_get_last_error)
 /* {{{ Retrieve array of errors */
 PHP_FUNCTION(libxml_get_errors)
 {
+	if (xmlParserVersion == NULL) return;
 
 	xmlErrorPtr error;
 
@@ -1107,6 +1153,8 @@ PHP_FUNCTION(libxml_get_errors)
 /* {{{ Clear last error from libxml */
 PHP_FUNCTION(libxml_clear_errors)
 {
+	if (xmlParserVersion == NULL) return;
+
 	ZEND_PARSE_PARAMETERS_NONE();
 
 	xmlResetLastError();
@@ -1127,6 +1175,8 @@ PHP_LIBXML_API zend_bool php_libxml_disable_entity_loader(zend_bool disable) /*
 /* {{{ Disable/Enable ability to load external entities */
 PHP_FUNCTION(libxml_disable_entity_loader)
 {
+	if (xmlParserVersion == NULL) return;
+
 	zend_bool disable = 1;
 
 	ZEND_PARSE_PARAMETERS_START(0, 1)
@@ -1141,6 +1191,8 @@ PHP_FUNCTION(libxml_disable_entity_loader)
 /* {{{ Changes the default external entity loader */
 PHP_FUNCTION(libxml_set_external_entity_loader)
 {
+	if (xmlParserVersion == NULL) return;
+
 	zend_fcall_info			fci;
 	zend_fcall_info_cache	fcc;
 
diff --git a/third_party/php8.0-src/ext/pdo_sqlite/pdo_sqlite.c b/third_party/php8.0-src/ext/pdo_sqlite/pdo_sqlite.c
index 60cd4c3..1aceeed 100644
--- a/third_party/php8.0-src/ext/pdo_sqlite/pdo_sqlite.c
+++ b/third_party/php8.0-src/ext/pdo_sqlite/pdo_sqlite.c
@@ -21,8 +21,8 @@
 #include "php.h"
 #include "php_ini.h"
 #include "ext/standard/info.h"
-#include "pdo/php_pdo.h"
-#include "pdo/php_pdo_driver.h"
+#include "../pdo/php_pdo.h"
+#include "../pdo/php_pdo_driver.h"
 #include "php_pdo_sqlite.h"
 #include "php_pdo_sqlite_int.h"
 #include "zend_exceptions.h"
diff --git a/third_party/php8.0-src/ext/pdo_sqlite/sqlite_driver.c b/third_party/php8.0-src/ext/pdo_sqlite/sqlite_driver.c
index 5a72a1e..257bcf5 100644
--- a/third_party/php8.0-src/ext/pdo_sqlite/sqlite_driver.c
+++ b/third_party/php8.0-src/ext/pdo_sqlite/sqlite_driver.c
@@ -21,8 +21,8 @@
 #include "php.h"
 #include "php_ini.h"
 #include "ext/standard/info.h"
-#include "pdo/php_pdo.h"
-#include "pdo/php_pdo_driver.h"
+#include "../pdo/php_pdo.h"
+#include "../pdo/php_pdo_driver.h"
 #include "php_pdo_sqlite.h"
 #include "php_pdo_sqlite_int.h"
 #include "zend_exceptions.h"
diff --git a/third_party/php8.0-src/ext/pdo_sqlite/sqlite_statement.c b/third_party/php8.0-src/ext/pdo_sqlite/sqlite_statement.c
index 3769b1e..7437f1f 100644
--- a/third_party/php8.0-src/ext/pdo_sqlite/sqlite_statement.c
+++ b/third_party/php8.0-src/ext/pdo_sqlite/sqlite_statement.c
@@ -21,8 +21,8 @@
 #include "php.h"
 #include "php_ini.h"
 #include "ext/standard/info.h"
-#include "pdo/php_pdo.h"
-#include "pdo/php_pdo_driver.h"
+#include "../pdo/php_pdo.h"
+#include "../pdo/php_pdo_driver.h"
 #include "php_pdo_sqlite.h"
 #include "php_pdo_sqlite_int.h"
 
diff --git a/third_party/php8.0-src/ext/phar/Makefile.frag b/third_party/php8.0-src/ext/phar/Makefile.frag
index 58789ca..dd5e6a7 100644
--- a/third_party/php8.0-src/ext/phar/Makefile.frag
+++ b/third_party/php8.0-src/ext/phar/Makefile.frag
@@ -31,13 +31,13 @@ $(builddir)/phar/phar.inc: $(srcdir)/phar/phar.inc
 
 $(builddir)/phar.php: $(srcdir)/build_precommand.php $(srcdir)/phar/*.inc $(srcdir)/phar/*.php $(SAPI_CLI_PATH)
 	-@echo "Generating phar.php"
-	@$(PHP_PHARCMD_EXECUTABLE) $(PHP_PHARCMD_SETTINGS) $(srcdir)/build_precommand.php > $(builddir)/phar.php
+	-@$(PHP_PHARCMD_EXECUTABLE) $(PHP_PHARCMD_SETTINGS) $(srcdir)/build_precommand.php > $(builddir)/phar.php
 
 $(builddir)/phar.phar: $(builddir)/phar.php $(builddir)/phar/phar.inc $(srcdir)/phar/*.inc $(srcdir)/phar/*.php $(SAPI_CLI_PATH)
 	-@echo "Generating phar.phar"
 	-@rm -f $(builddir)/phar.phar
 	-@rm -f $(srcdir)/phar.phar
-	@$(PHP_PHARCMD_EXECUTABLE) $(PHP_PHARCMD_SETTINGS) $(builddir)/phar.php pack -f $(builddir)/phar.phar -a pharcommand -c auto -x \\.svn -p 0 -s $(srcdir)/phar/phar.php -h sha1 -b "$(PHP_PHARCMD_BANG)"  $(srcdir)/phar/
+	-@$(PHP_PHARCMD_EXECUTABLE) $(PHP_PHARCMD_SETTINGS) $(builddir)/phar.php pack -f $(builddir)/phar.phar -a pharcommand -c auto -x \\.svn -p 0 -s $(srcdir)/phar/phar.php -h sha1 -b "$(PHP_PHARCMD_BANG)"  $(srcdir)/phar/
 	-@chmod +x $(builddir)/phar.phar
 
 install-pharcmd: pharcmd
diff --git a/third_party/php8.0-src/ext/tokenizer/tokenizer.c b/third_party/php8.0-src/ext/tokenizer/tokenizer.c
index 7567a27..fd155f7 100644
--- a/third_party/php8.0-src/ext/tokenizer/tokenizer.c
+++ b/third_party/php8.0-src/ext/tokenizer/tokenizer.c
@@ -345,7 +345,7 @@ static void add_token(
 	zend_hash_next_index_insert_new(Z_ARRVAL_P(return_value), &token);
 }
 
-static zend_bool tokenize(zval *return_value, zend_string *source, zend_class_entry *token_class)
+zend_bool tokenize(zval *return_value, zend_string *source, zend_class_entry *token_class)
 {
 	zval source_zval;
 	zend_lex_state original_lex_state;
diff --git a/third_party/php8.0-src/main/fastcgi.c b/third_party/php8.0-src/main/fastcgi.c
index bb9c2b2..c1176df 100644
--- a/third_party/php8.0-src/main/fastcgi.c
+++ b/third_party/php8.0-src/main/fastcgi.c
@@ -558,6 +558,7 @@ void fcgi_shutdown(void)
 {
 	if (is_initialized) {
 		zend_hash_destroy(&fcgi_mgmt_vars);
+		is_initialized = 0;
 	}
 	is_fastcgi = 0;
 	if (allowed_clients) {
diff --git a/third_party/php8.0-src/sapi/cgi/cgi_main.c b/third_party/php8.0-src/sapi/cgi/cgi_main.c
index 0d52941..ac46a7a 100644
--- a/third_party/php8.0-src/sapi/cgi/cgi_main.c
+++ b/third_party/php8.0-src/sapi/cgi/cgi_main.c
@@ -18,7 +18,7 @@
    |          Dmitry Stogov <dmitry@php.net>                              |
    +----------------------------------------------------------------------+
 */
-
+#include <emscripten.h>
 #include "php.h"
 #include "php_globals.h"
 #include "php_variables.h"
@@ -1883,7 +1883,7 @@ int main(int argc, char *argv[])
 	SG(request_info).path_translated = NULL;
 #endif
 
-	cgi_sapi_module.executable_location = argv[0];
+	// cgi_sapi_module.executable_location = argv[0];
 	if (!cgi && !fastcgi && !bindpath) {
 		cgi_sapi_module.additional_functions = additional_functions;
 	}
@@ -1959,8 +1959,10 @@ consult the installation file that came with this distribution, or visit \n\
 	}
 
 	/* make php call us to get _ENV vars */
-	php_php_import_environment_variables = php_import_environment_variables;
-	php_import_environment_variables = cgi_php_import_environment_variables;
+	if(php_import_environment_variables != cgi_php_import_environment_variables) {
+		php_php_import_environment_variables = php_import_environment_variables;
+		php_import_environment_variables = cgi_php_import_environment_variables;
+	}
 
 	if (fastcgi) {
 		/* How many times to run PHP scripts before dying */
@@ -2672,3 +2674,18 @@ parent_out:
 	return exit_status;
 }
 /* }}} */
+
+void EMSCRIPTEN_KEEPALIVE wasm_sapi_cgi_init(void)
+{
+	putenv("USE_ZEND_ALLOC=0");
+}
+
+char* EMSCRIPTEN_KEEPALIVE wasm_sapi_cgi_getenv(char *name)
+{
+	return getenv(name);
+}
+
+char* EMSCRIPTEN_KEEPALIVE wasm_sapi_cgi_putenv(char *name, char *value)
+{
+	return _sapi_cgi_putenv(name, strlen(name), value);
+}
diff --git a/third_party/php8.0-src/sapi/embed/php_embed.c b/third_party/php8.0-src/sapi/embed/php_embed.c
index b510d51..97cc812 100644
--- a/third_party/php8.0-src/sapi/embed/php_embed.c
+++ b/third_party/php8.0-src/sapi/embed/php_embed.c
@@ -204,8 +204,8 @@ EMBED_SAPI_API int php_embed_init(int argc, char **argv)
 	  return FAILURE;
   }
 
-  SG(headers_sent) = 1;
-  SG(request_info).no_headers = 1;
+  SG(headers_sent) = 0;
+  SG(request_info).no_headers = 0;
   php_register_variable("PHP_SELF", "-", NULL);
 
   return SUCCESS;
diff --git a/third_party/php8.0-src/sapi/cgi/Makefile.frag b/third_party/php8.0-src/sapi/cgi/Makefile.frag
index 79e2afe..0956f43 100644
--- a/third_party/php8.0-src/sapi/cgi/Makefile.frag
+++ b/third_party/php8.0-src/sapi/cgi/Makefile.frag
@@ -1,7 +1,7 @@
 cgi: $(SAPI_CGI_PATH)
 
 $(SAPI_CGI_PATH): $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_FASTCGI_OBJS) $(PHP_CGI_OBJS)
-	$(BUILD_CGI)
+	$(BUILD_CGI) $(WASM_SHARED_LIBS)
 
 install-cgi: $(SAPI_CGI_PATH)
 	@echo "Installing PHP CGI binary:        $(INSTALL_ROOT)$(bindir)/"
diff --git a/third_party/php8.0-src/sapi/cli/Makefile.frag b/third_party/php8.0-src/sapi/cli/Makefile.frag
index aa1d642..649533d 100644
--- a/third_party/php8.0-src/sapi/cli/Makefile.frag
+++ b/third_party/php8.0-src/sapi/cli/Makefile.frag
@@ -1,7 +1,7 @@
 cli: $(SAPI_CLI_PATH)
 
 $(SAPI_CLI_PATH): $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_CLI_OBJS)
-	$(BUILD_CLI)
+	$(BUILD_CLI) $(WASM_SHARED_LIBS)
 
 install-cli: $(SAPI_CLI_PATH)
 	@echo "Installing PHP CLI binary:        $(INSTALL_ROOT)$(bindir)/"
diff --git a/third_party/php8.0-src/sapi/phpdbg/Makefile.frag b/third_party/php8.0-src/sapi/phpdbg/Makefile.frag
index 2e2faf80..9cbb0486 100644
--- a/third_party/php8.0-src/sapi/phpdbg/Makefile.frag
+++ b/third_party/php8.0-src/sapi/phpdbg/Makefile.frag
@@ -6,7 +6,7 @@ $(BUILD_SHARED): $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_PHPDBG_OBJS)
 	$(BUILD_PHPDBG_SHARED)
 
 $(BUILD_BINARY): $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_PHPDBG_OBJS)
-	$(BUILD_PHPDBG)
+	$(BUILD_PHPDBG) $(WASM_SHARED_LIBS)
 
 %.c: %.y
 %.c: %.l
